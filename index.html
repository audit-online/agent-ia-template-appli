<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent IA - G√©n√©rateur de Prototypes d'Applications</title>

  <!-- React + Babel CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* ------- RESET + LAYOUT √âQUILIBR√â ------- */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f7fa;min-height:100vh;color:#333}
    .app-container{display:grid;grid-template-columns:1fr 400px;height:100vh;gap:1px;background:#e5e7eb}
    
    /* ZONE PRINCIPALE - CONVERSATION */
    .main-area{background:#fff;display:flex;flex-direction:column;overflow:hidden}
    .main-header{padding:20px 30px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-bottom:1px solid rgba(255,255,255,.2)}
    .main-header h1{font-size:1.4rem;font-weight:700;margin-bottom:5px}
    .main-header p{opacity:.9;font-size:.9rem}
    .status-badge{display:inline-flex;align-items:center;gap:8px;margin-top:10px;padding:6px 12px;background:rgba(255,255,255,.2);border-radius:15px;font-size:.8rem}
    .status-dot{width:6px;height:6px;border-radius:50%;background:#4ade80;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    
    /* CONVERSATION */
    .conversation{flex:1;overflow-y:auto;padding:25px;background:#fafbfc}
    .message{margin-bottom:20px;max-width:85%}
    .message.user{margin-left:auto}
    .message.user .bubble{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:20px 20px 5px 20px;padding:15px 20px;box-shadow:0 3px 15px rgba(102,126,234,.3)}
    .message.agent .bubble{background:#fff;border:1px solid #e5e7eb;border-radius:20px 20px 20px 5px;padding:15px 20px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .message-content{white-space:pre-line;line-height:1.6;font-size:14px}
    
    /* INPUT ZONE */
    .input-zone{padding:20px;background:#fff;border-top:1px solid #e5e7eb}
    .input-container{display:flex;gap:12px;align-items:end}
    .input-wrapper{flex:1;position:relative}
    .input-field{width:100%;min-height:50px;max-height:120px;padding:12px 16px;border:2px solid #e5e7eb;border-radius:15px;font-size:14px;font-family:inherit;resize:none;transition:all .2s;background:#f8fafc}
    .input-field:focus{outline:none;border-color:#667eea;background:#fff;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .send-btn{padding:12px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:15px;font-weight:600;cursor:pointer;transition:all .2s}
    .send-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 15px rgba(102,126,234,.4)}
    .send-btn:disabled{opacity:.6;cursor:not-allowed}
    
    /* SIDEBAR PROTOTYPES */
    .sidebar{background:#fff;display:flex;flex-direction:column;overflow:hidden}
    .sidebar-header{padding:20px;background:#f8fafc;border-bottom:1px solid #e5e7eb}
    .sidebar-title{font-size:1.1rem;font-weight:700;color:#374151;margin-bottom:10px}
    .current-prototype{background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:15px;border-radius:12px;text-align:center;font-size:13px}
    .current-prototype .name{font-weight:600;margin-bottom:5px}
    .current-prototype .actions{display:flex;gap:8px;justify-content:center;margin-top:10px}
    .btn-sm{padding:6px 12px;border:none;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-outline{background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3)}
    .btn-outline:hover{background:rgba(255,255,255,.3)}
    
    /* LISTE PROTOTYPES */
    .prototypes-list{flex:1;overflow-y:auto}
    .prototype-item{padding:15px 20px;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:all .2s}
    .prototype-item:hover{background:#f8fafc}
    .prototype-item.active{background:#f0f9ff;border-left:3px solid #3b82f6}
    .prototype-name{font-weight:600;color:#111827;font-size:13px;margin-bottom:5px}
    .prototype-meta{color:#6b7280;font-size:11px;margin-bottom:8px}
    .prototype-actions{display:flex;gap:6px}
    .btn-xs{padding:4px 8px;font-size:10px;border-radius:6px;border:none;cursor:pointer;transition:all .2s}
    .btn-primary{background:#3b82f6;color:#fff}
    .btn-secondary{background:#f3f4f6;color:#374151}
    .btn-xs:hover{transform:translateY(-1px)}
    
    /* LOADING */
    .thinking{display:flex;align-items:center;gap:10px;padding:15px 20px;background:#f0f9ff;border-radius:20px 20px 20px 5px;margin-bottom:20px;max-width:85%}
    .dots{display:flex;gap:4px}
    .dot{width:6px;height:6px;border-radius:50%;background:#3b82f6;animation:bounce 1.4s infinite ease-in-out}
    .dot:nth-child(1){animation-delay:-0.32s}
    .dot:nth-child(2){animation-delay:-0.16s}
    @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
    
    /* RESPONSIVE */
    @media(max-width:1024px){.app-container{grid-template-columns:1fr 300px}}
    @media(max-width:768px){.app-container{grid-template-columns:1fr;grid-template-rows:1fr auto}.sidebar{max-height:250px}}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [messages, setMessages] = useState([]);
      const [inputMessage, setInputMessage] = useState('');
      const [prototypes, setPrototypes] = useState([]);
      const [isGenerating, setIsGenerating] = useState(false);
      const [currentPrototype, setCurrentPrototype] = useState(null);
      const [apiStatus, setApiStatus] = useState('testing');

      useEffect(() => {
        testAPI();
        
        // Test de la fonction d'ouverture d'onglet
        console.log('üß™ Test fonction ouverture onglet...');
        
        setMessages([{
          id: 1,
          type: 'agent',
          content: 'üöÄ **Agent IA - G√©n√©rateur de Prototypes d\'Applications**\n\nJe suis Claude, expert en cr√©ation de **prototypes d\'applications compl√®tes** !\n\n**Ce que je cr√©e pour vous :**\n‚Ä¢ üì± Applications web interactives compl√®tes\n‚Ä¢ üé® Design haut de gamme niveau production\n‚Ä¢ üíæ Donn√©es simul√©es r√©alistes\n‚Ä¢ üîÑ Navigation fluide multi-√©crans\n‚Ä¢ üìä Tableaux de bord avec graphiques\n‚Ä¢ üí≥ Processus m√©tier complets\n\n**Vos clients verront une VRAIE application fonctionnelle !**\n\nD√©crivez-moi votre projet et je cr√©erai un prototype professionnel que vos clients pourront tester comme une vraie app ! üíº‚ú®'
        }]);
      }, []);

      const testAPI = async () => {
        try {
          const r = await fetch('/.netlify/functions/ai-chat', { method: 'GET' });
          const data = await r.json();
          setApiStatus('working');
          setMessages(prev => [...prev, { 
            id: Date.now(), 
            type: 'agent', 
            content: `‚úÖ API active - Cl√© configur√©e (${data.keyLength} caract√®res)` 
          }]);
        } catch {
          setApiStatus('broken');
          setMessages(prev => [...prev, { 
            id: Date.now(), 
            type: 'agent', 
            content: '‚ùå API indisponible - Mode test activ√©' 
          }]);
        }
      };

      const openPrototype = (prototype) => {
        try {
          console.log('üöÄ Ouverture prototype:', prototype.name);
          const blob = new Blob([prototype.htmlCode], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const newWindow = window.open(url, '_blank');
          
          if (newWindow) {
            console.log('‚úÖ Onglet ouvert avec succ√®s');
            setTimeout(() => URL.revokeObjectURL(url), 2000);
          } else {
            console.error('‚ùå Popup bloqu√©');
            // Fallback: t√©l√©charger si popup bloqu√©
            const a = document.createElement('a');
            a.href = url;
            a.download = `prototype-${prototype.id}.html`;
            a.click();
            URL.revokeObjectURL(url);
          }
        } catch (error) {
          console.error('‚ùå Erreur ouverture:', error);
        }
      };

      const downloadPrototype = (prototype) => {
        try {
          console.log('üíæ T√©l√©chargement prototype:', prototype.name);
          const blob = new Blob([prototype.htmlCode], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `prototype-${prototype.id}.html`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          console.log('‚úÖ T√©l√©chargement lanc√©');
        } catch (error) {
          console.error('‚ùå Erreur t√©l√©chargement:', error);
        }
      };

      const detectType = (input) => {
        const lower = input.toLowerCase();
        if (lower.includes('restaurant') || lower.includes('kebab')) return 'restaurant';
        if (lower.includes('boutique') || lower.includes('shop')) return 'ecommerce';
        if (lower.includes('portfolio')) return 'portfolio';
        if (lower.includes('crm') || lower.includes('gestion')) return 'business';
        return 'moderne';
      };

      const createPrototype = (userInput, htmlCode, source) => {
        const prototype = {
          id: Date.now(),
          name: `App ${detectType(userInput)} ‚Äì ${new Date().toLocaleTimeString()}`,
          userInput,
          htmlCode,
          source,
          createdAt: new Date()
        };
        setPrototypes(prev => [prototype, ...prev]);
        setCurrentPrototype(prototype);
        return prototype;
      };

      const handleSendMessage = async () => {
        if (!inputMessage.trim() || isGenerating) return;
        
        const userMessage = { id: Date.now(), type: 'user', content: inputMessage };
        const messageContent = inputMessage;
        setInputMessage('');
        setMessages(prev => [...prev, userMessage]);

        if (apiStatus !== 'working') {
          setMessages(prev => [...prev, { 
            id: Date.now(), 
            type: 'agent', 
            content: 'API non disponible. V√©rifiez la configuration.' 
          }]);
          return;
        }

        setIsGenerating(true);

        try {
          const fullConversation = [...messages, userMessage];
          const conversationHistory = fullConversation
            .filter(msg => msg.id !== 1)
            .map(msg => ({ role: msg.type === 'user' ? 'user' : 'assistant', content: msg.content }));

          // D√©tecter si c'est une demande de modification
          const isModificationRequest = currentPrototype && 
            (messageContent.toLowerCase().includes('modifi') ||
             messageContent.toLowerCase().includes('change') ||
             messageContent.toLowerCase().includes('ajuste') ||
             messageContent.toLowerCase().includes('am√©liore') ||
             messageContent.toLowerCase().includes('couleur') ||
             messageContent.toLowerCase().includes('taille'));

          let systemPrompt;
          
          if (isModificationRequest) {
            systemPrompt = `Tu es un expert en modification de PROTOTYPES D'APPLICATION. 

CONTEXTE : L'utilisateur a un prototype d'application et veut le modifier.

PROTOTYPE ACTUEL :
${currentPrototype.htmlCode}

DEMANDE DE MODIFICATION : ${messageContent}

INSTRUCTIONS :
1. Analyse le prototype d'application existant
2. Applique EXACTEMENT la modification demand√©e
3. Conserve toute la structure, navigation et fonctionnalit√©s
4. Maintiens le niveau de qualit√© haut de gamme
5. Assure-toi que toutes les interactions restent fonctionnelles
6. Retourne le HTML complet modifi√© (DOCTYPE ‚Üí </html>)

IMPORTANT : R√©ponds UNIQUEMENT avec le code HTML complet du prototype modifi√©.`;
          } else {
            systemPrompt = `Tu es Claude, expert senior en cr√©ation de PROTOTYPES D'APPLICATIONS compl√®tes et interactives.

MISSION : Cr√©er des prototypes d'applications haut de gamme pour impressionner les clients.

R√àGLES POUR LES PROTOTYPES :
- Cr√©e des APPLICATIONS COMPL√àTES, pas des sites vitrines
- Design niveau PRODUCTION (moderne, professionnel, premium)
- FONCTIONNALIT√âS R√âELLES : navigation, formulaires, donn√©es simul√©es
- MULTI-√âCRANS : plusieurs pages/vues dans la m√™me app
- DONN√âES SIMUL√âES r√©alistes (clients, commandes, stats, etc.)
- INTERACTIONS avanc√©es : modals, drag&drop, animations fluides
- RESPONSIVE parfait mobile/desktop
- PERFORMANCE optimis√©e

STRUCTURE TYPE D'APPLICATION :
1. √âcran de connexion/accueil
2. Tableau de bord principal
3. Modules m√©tier (selon le secteur)
4. Param√®tres/profil
5. Navigation fluide entre tout

TECHNOLOGIES √Ä UTILISER :
- HTML5 + CSS3 moderne (flexbox, grid, animations)
- JavaScript vanilla avanc√©
- Charts.js pour graphiques (via CDN)
- Ic√¥nes (CSS ou SVG inline)
- Donn√©es JSON simul√©es en dur
- LocalStorage pour persistance

SECTEURS D'EXPERTISE :
- Restaurant : Backoffice + App client + Caisse
- E-commerce : Admin + Boutique + Gestion
- Services : CRM + Facturation + Planning
- Immobilier : Gestion biens + Prospects + Visites

QUALIT√â EXIG√âE :
- Code propre et organis√©
- Design coh√©rent et moderne
- Fonctionnalit√©s r√©ellement utilisables
- Donn√©es cr√©dibles et vari√©es
- UX intuitive et fluide

IMPORTANT : Cr√©e une VRAIE APPLICATION que le client peut tester comme si c'√©tait un produit fini !

M√âMOIRE : Utilise tout l'historique pour cr√©er l'app parfaite selon les besoins discut√©s.

HISTORIQUE : ${JSON.stringify(conversationHistory, null, 2)}`;
          }

          const res = await fetch('/.netlify/functions/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: messageContent,
              conversationHistory: conversationHistory,
              systemPrompt: systemPrompt
            })
          });

          const data = await res.json();
          
          // V√©rifier si c'est un prototype HTML complet
          const isRealPrototype = data.response.includes('<!DOCTYPE html>') && 
                                data.response.includes('<html') && 
                                data.response.includes('</html>') &&
                                data.response.length > 1000;
          
          if (isRealPrototype) {
            let html = data.response.replace(/```html\n?/g, '').replace(/```\n?/g, '').trim();
            
            if (isModificationRequest) {
              // Modification d'un prototype existant
              const modifiedPrototype = {
                ...currentPrototype,
                id: Date.now(),
                name: currentPrototype.name.replace('‚Äì', '(modifi√©) ‚Äì'),
                htmlCode: html,
                source: 'ai-modified'
              };
              setPrototypes(prev => [modifiedPrototype, ...prev]);
              setCurrentPrototype(modifiedPrototype);
              
              setMessages(prev => [...prev, { 
                id: Date.now(), 
                type: 'agent', 
                content: '‚úÖ **Prototype d\'application modifi√© !** Les changements ont √©t√© appliqu√©s avec succ√®s. Testez votre application mise √† jour !' 
              }]);
              
              setTimeout(() => {
                console.log('‚è∞ Ouverture automatique prototype modifi√©...');
                openPrototype(modifiedPrototype);
              }, 1000);
            } else {
              // Nouveau prototype
              const prototype = createPrototype(messageContent, html, 'ai-expert');
              setMessages(prev => [...prev, { 
                id: Date.now(), 
                type: 'agent', 
                content: 'üöÄ **Prototype d\'application cr√©√© !** Votre application professionnelle va s\'ouvrir automatiquement. Vos clients vont √™tre impressionn√©s !' 
              }]);
              
              setTimeout(() => {
                console.log('‚è∞ Ouverture automatique nouveau prototype...');
                openPrototype(prototype);
              }, 1000);
            }
          } else {
            // R√©ponse normale
            setMessages(prev => [...prev, { 
              id: Date.now(), 
              type: 'agent', 
              content: data.response 
            }]);
          }
          
        } catch (error) {
          setMessages(prev => [...prev, { 
            id: Date.now(), 
            type: 'agent', 
            content: 'Erreur technique. Pouvez-vous reformuler ?' 
          }]);
        } finally {
          setIsGenerating(false);
        }
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSendMessage();
        }
      };

      return (
        React.createElement('div', { className: 'app-container' },
          
          // ZONE PRINCIPALE - CONVERSATION
          React.createElement('div', { className: 'main-area' },
            React.createElement('div', { className: 'main-header' },
              React.createElement('h1', null, 'Agent IA - Prototypes d\'Apps'),
              React.createElement('p', null, 'G√©n√©rateur d\'applications professionnelles'),
              React.createElement('div', { className: 'status-badge' },
                React.createElement('div', { className: 'status-dot' }),
                apiStatus === 'working' ? 'IA Claude Active' : 'Mode Test'
              )
            ),
            
            React.createElement('div', { className: 'conversation' },
              messages.map(msg => 
                React.createElement('div', { key: msg.id, className: `message ${msg.type}` },
                  React.createElement('div', { className: 'bubble' },
                    React.createElement('div', { className: 'message-content' }, msg.content)
                  )
                )
              ),
              
              isGenerating && React.createElement('div', { className: 'thinking' },
                React.createElement('div', { className: 'dots' },
                  React.createElement('div', { className: 'dot' }),
                  React.createElement('div', { className: 'dot' }),
                  React.createElement('div', { className: 'dot' })
                ),
                React.createElement('span', null, 'Claude cr√©e votre prototype...')
              )
            ),
            
            React.createElement('div', { className: 'input-zone' },
              React.createElement('div', { className: 'input-container' },
                React.createElement('div', { className: 'input-wrapper' },
                  React.createElement('textarea', {
                    className: 'input-field',
                    value: inputMessage,
                    onChange: e => setInputMessage(e.target.value),
                    onKeyPress: handleKeyPress,
                    placeholder: currentPrototype ? 
                      'Demandez des am√©liorations de votre prototype...' : 
                      'D√©crivez l\'application que vous voulez cr√©er...',
                    disabled: isGenerating
                  })
                ),
                React.createElement('button', {
                  className: 'send-btn',
                  onClick: handleSendMessage,
                  disabled: !inputMessage.trim() || isGenerating
                }, '‚Üí')
              )
            )
          ),
          
          // SIDEBAR PROTOTYPES
          React.createElement('div', { className: 'sidebar' },
            React.createElement('div', { className: 'sidebar-header' },
              React.createElement('div', { className: 'sidebar-title' }, 'Prototypes d\'Apps'),
              
              currentPrototype && React.createElement('div', { className: 'current-prototype' },
                React.createElement('div', { className: 'name' }, currentPrototype.name),
                React.createElement('div', null, 'Prototype actuel'),
                React.createElement('div', { className: 'actions' },
                  React.createElement('button', { 
                    className: 'btn-sm btn-outline', 
                    onClick: () => {
                      console.log('üñ±Ô∏è Clic bouton Tester App - Prototype:', currentPrototype.name);
                      openPrototype(currentPrototype);
                    }
                  }, 'üöÄ Tester App'),
                  React.createElement('button', { 
                    className: 'btn-sm btn-outline', 
                    onClick: () => downloadPrototype(currentPrototype)
                  }, 'üíæ DL')
                )
              ),
              
              // Demo prototype si pas de prototype
              !currentPrototype && React.createElement('button', {
                className: 'btn-sm',
                style: { background: '#f59e0b', color: '#fff', width: '100%', marginTop: '10px' },
                onClick: () => {
                  const demoHTML = `<!DOCTYPE html><html><head><title>Demo App Restaurant</title><style>body{font-family:system-ui;margin:0;background:#f8fafc}.container{max-width:1200px;margin:0 auto;padding:20px}.header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:20px;border-radius:15px;margin-bottom:20px}.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}.card{background:#fff;padding:20px;border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,0.1);border:1px solid #e5e7eb}.card h3{color:#1f2937;margin-bottom:10px}.btn{background:#10b981;color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;margin-top:10px}.btn:hover{background:#059669}</style></head><body><div class="container"><div class="header"><h1>üè™ Restaurant Manager Pro</h1><p>Prototype d'application compl√®te de gestion</p></div><div class="grid"><div class="card"><h3>üìä Tableau de Bord</h3><p>Vue d'ensemble des ventes, commandes et statistiques en temps r√©el</p><button class="btn">Acc√©der</button></div><div class="card"><h3>üì± App Client</h3><p>Interface client pour commandes, livraisons et paiements</p><button class="btn">Tester</button></div><div class="card"><h3>üí∞ Caisse</h3><p>Syst√®me de caisse connect√© avec gestion des paiements</p><button class="btn">Ouvrir</button></div><div class="card"><h3>üìã Gestion Stock</h3><p>Inventaire, fournisseurs et approvisionnements</p><button class="btn">G√©rer</button></div><div class="card"><h3>üë• √âquipe</h3><p>Planning, paie et gestion des employ√©s</p><button class="btn">Planifier</button></div><div class="card"><h3>üìà Analytics</h3><p>Rapports d√©taill√©s et analyses de performance</p><button class="btn">Analyser</button></div></div></div></body></html>`;
                  const demoApp = { id: 'demo', name: 'Demo App Restaurant', htmlCode: demoHTML };
                  console.log('üé¨ Ouverture demo prototype...');
                  openPrototype(demoApp);
                }
              }, 'üé¨ Voir Demo Prototype')
            ),
            
            React.createElement('div', { className: 'prototypes-list' },
              prototypes.map(t => 
                React.createElement('div', { 
                  key: t.id, 
                  className: `prototype-item ${currentPrototype?.id === t.id ? 'active' : ''}`,
                  onClick: () => setCurrentPrototype(t)
                },
                  React.createElement('div', { className: 'prototype-name' }, t.name),
                  React.createElement('div', { className: 'prototype-meta' }, 
                    `${t.source} ‚Ä¢ ${t.createdAt.toLocaleTimeString()}`
                  ),
                  React.createElement('div', { className: 'prototype-actions' },
                    React.createElement('button', { 
                      className: 'btn-xs btn-primary', 
                      onClick: e => { e.stopPropagation(); openPrototype(t); }
                    }, 'Tester'),
                    React.createElement('button', { 
                      className: 'btn-xs btn-secondary', 
                      onClick: e => { e.stopPropagation(); downloadPrototype(t); }
                    }, 'DL')
                  )
                )
              ),
              
              prototypes.length === 0 && React.createElement('div', { 
                style: { padding: '20px', textAlign: 'center', color: '#6b7280', fontSize: '13px' }
              }, 'Aucun prototype cr√©√©')
            )
          )
        )
      );
    };

    ReactDOM.render(React.createElement(App), document.getElementById('root'));
  </script>
</body>
</html>