<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent IA Template</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            background: #f8fafc;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .chat-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }
        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            max-width: 80%;
        }
        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }
        .message.agent {
            background: white;
            border: 1px solid #e2e8f0;
        }
        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }
        .input-group {
            display: flex;
            gap: 10px;
        }
        .input-group input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
        }
        .btn-success {
            background: #48bb78;
            color: white;
        }
        .btn-success:hover {
            background: #38a169;
        }
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .template-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        .template-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            height: 80%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body {
            flex: 1;
            padding: 20px;
            overflow: hidden;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }
        .preview-iframe {
            width: 100%;
            height: 500px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .code-textarea {
            width: 100%;
            height: 500px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            resize: none;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const App = () => {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [templates, setTemplates] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            const [previewModal, setPreviewModal] = useState(null);
            const [apiStatus, setApiStatus] = useState('testing');

            useEffect(() => {
                testAPI();
                setMessages([{
                    id: 1,
                    type: 'agent',
                    content: 'Agent IA Template - Version Debug\n\nDiagnostic en cours...\n\nJe teste si l API fonctionne, puis je vous donnerai un template fonctionnel.\n\nStatut : Test de l API Netlify...'
                }]);
            }, []);

            const testAPI = async () => {
                try {
                    const response = await fetch('/.netlify/functions/ai-chat', {
                        method: 'GET'
                    });
                    
                    if (response.ok) {
                        setApiStatus('working');
                        setMessages(prev => [...prev, {
                            id: Date.now(),
                            type: 'agent',
                            content: 'API Netlify fonctionnelle !\n\nJe peux maintenant generer des templates avec l IA Claude.\n\nDecrivez votre projet pour commencer.'
                        }]);
                    } else {
                        throw new Error('API inaccessible: ' + response.status);
                    }
                } catch (error) {
                    setApiStatus('broken');
                    setMessages(prev => [...prev, {
                        id: Date.now(),
                        type: 'agent',
                        content: 'Probleme detecte : API Netlify inaccessible\n\nErreur : ' + error.message + '\n\nSolutions immediates :\n\n1. Verifiez le deploiement Netlify\n2. Verifiez la cle API Claude\n3. Testez directement la fonction\n\nEN ATTENDANT : Je peux creer un template de base pour tester.'
                    }]);
                }
            };

            const handleSendMessage = async () => {
                if (!inputMessage.trim()) return;

                const userMessage = {
                    id: Date.now(),
                    type: 'user',
                    content: inputMessage
                };

                setMessages(prev => [...prev, userMessage]);
                setInputMessage('');

                if (apiStatus === 'working') {
                    await generateWithAI(inputMessage);
                } else {
                    generateTestTemplate(inputMessage);
                }
            };

            const generateWithAI = async (userInput) => {
                setIsGenerating(true);
                
                try {
                    const response = await fetch('/.netlify/functions/ai-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: 'Genere un template HTML complet pour: ' + userInput,
                            systemPrompt: 'Cree un template HTML complet et professionnel. Reponds UNIQUEMENT avec du code HTML complet. Le HTML doit inclure: DOCTYPE html, Head avec meta tags, CSS integre, Body avec contenu complet, JavaScript si necessaire. Genere du code pret a utiliser, moderne et responsive.'
                        })
                    });

                    if (!response.ok) throw new Error('Erreur ' + response.status);

                    const result = await response.json();
                    let htmlCode = result.response;
                    
                    htmlCode = htmlCode.replace(/```html\n?/g, '').replace(/```\n?/g, '').trim();
                    
                    if (htmlCode.includes('<!DOCTYPE') && htmlCode.includes('</html>')) {
                        createTemplate(userInput, htmlCode, 'ai');
                        setMessages(prev => [...prev, {
                            id: Date.now(),
                            type: 'agent',
                            content: 'Template genere par l IA Claude !\n\nCode HTML complet cree. Cliquez sur Previsualiser pour voir le resultat.'
                        }]);
                    } else {
                        throw new Error('Code HTML invalide genere par l IA');
                    }
                } catch (error) {
                    console.error('Erreur IA:', error);
                    generateTestTemplate(userInput);
                    setMessages(prev => [...prev, {
                        id: Date.now(),
                        type: 'agent',
                        content: 'Erreur IA, template de test cree\n\nErreur: ' + error.message + '\n\nJ ai cree un template de base pour tester.'
                    }]);
                } finally {
                    setIsGenerating(false);
                }
            };

            const generateTestTemplate = (userInput) => {
                const testHTML = createTestHTML(userInput);
                createTemplate(userInput, testHTML, 'test');
                
                setMessages(prev => [...prev, {
                    id: Date.now(),
                    type: 'agent',
                    content: 'Template de test cree\n\nCe template permet de verifier que la previsualisation fonctionne.\n\nCorrigez l API pour avoir des templates IA de qualite.'
                }]);
            };

            const createTestHTML = (userInput) => {
                const part1 = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Test</title><style>';
                const part2 = 'body{font-family:Arial;margin:0;padding:20px;background:#f5f5f5}';
                const part3 = '.header{background:#4a90e2;color:white;padding:40px;text-align:center}';
                const part4 = '.content{background:white;padding:40px;margin:20px 0}';
                const part5 = '.card{background:#fff;border:1px solid #ddd;padding:20px;margin:10px 0}';
                const part6 = '</style></head><body>';
                const part7 = '<div class="header"><h1>Template Test</h1><p>Demande: ' + userInput + '</p></div>';
                const part8 = '<div class="content"><h2>Test Reussi</h2>';
                const part9 = '<div class="card"><h3>Design</h3><p>Template fonctionnel.</p></div>';
                const part10 = '<div class="card"><h3>Code</h3><p>HTML et CSS integres.</p></div>';
                const part11 = '</div></body></html>';
                
                return part1 + part2 + part3 + part4 + part5 + part6 + part7 + part8 + part9 + part10 + part11;
            };

            const detectType = (input) => {
                const lower = input.toLowerCase();
                if (lower.includes('restaurant') || lower.includes('cafe') || lower.includes('food')) return 'restaurant';
                if (lower.includes('boutique') || lower.includes('ecommerce') || lower.includes('shop')) return 'ecommerce';
                if (lower.includes('portfolio') || lower.includes('artiste') || lower.includes('photo')) return 'portfolio';
                return 'business';
            };

            const createTemplate = (userInput, htmlCode, source) => {
                const template = {
                    id: Date.now(),
                    name: 'Template ' + detectType(userInput) + ' - ' + new Date().toLocaleTimeString(),
                    userInput,
                    htmlCode,
                    source,
                    createdAt: new Date()
                };
                
                setTemplates(prev => [...prev, template]);
            };

            const PreviewModal = ({ template, onClose }) => {
                const [activeTab, setActiveTab] = useState('preview');

                return (
                    React.createElement('div', { className: 'modal', onClick: onClose },
                        React.createElement('div', { className: 'modal-content', onClick: e => e.stopPropagation() },
                            React.createElement('div', { className: 'modal-header' },
                                React.createElement('div', null,
                                    React.createElement('h2', null, template.name),
                                    React.createElement('p', { style: { fontSize: '14px', color: '#666', marginTop: '5px' } },
                                        '"' + template.userInput + '" | Source: ' + template.source
                                    )
                                ),
                                React.createElement('button', { onClick: onClose, className: 'btn', style: { padding: '8px 12px' } }, '✕')
                            ),
                            React.createElement('div', { className: 'tabs' },
                                React.createElement('button', {
                                    className: 'tab ' + (activeTab === 'preview' ? 'active' : ''),
                                    onClick: () => setActiveTab('preview')
                                }, 'Apercu'),
                                React.createElement('button', {
                                    className: 'tab ' + (activeTab === 'code' ? 'active' : ''),
                                    onClick: () => setActiveTab('code')
                                }, 'Code')
                            ),
                            React.createElement('div', { className: 'modal-body' },
                                activeTab === 'preview' 
                                    ? React.createElement('iframe', {
                                        srcDoc: template.htmlCode,
                                        className: 'preview-iframe',
                                        title: 'Preview'
                                    })
                                    : React.createElement('div', null,
                                        React.createElement('div', { style: { marginBottom: '10px', display: 'flex', justifyContent: 'space-between' } },
                                            React.createElement('span', { style: { fontSize: '14px', color: '#666' } },
                                                'Code HTML (' + template.htmlCode.length + ' caracteres)'
                                            ),
                                            React.createElement('button', {
                                                onClick: () => {
                                                    navigator.clipboard.writeText(template.htmlCode);
                                                    alert('Code copie !');
                                                },
                                                className: 'btn btn-primary',
                                                style: { padding: '6px 12px', fontSize: '12px' }
                                            }, 'Copier')
                                        ),
                                        React.createElement('textarea', {
                                            className: 'code-textarea',
                                            value: template.htmlCode,
                                            readOnly: true
                                        })
                                    )
                            )
                        )
                    )
                );
            };

            return (
                React.createElement('div', { className: 'container' },
                    React.createElement('div', { className: 'chat-container' },
                        React.createElement('div', { className: 'chat-header' },
                            React.createElement('h1', null, 'Agent IA Template - Version Debug'),
                            React.createElement('p', null, 'Diagnostic et correction en temps reel')
                        ),
                        React.createElement('div', { className: 'chat-messages' },
                            messages.map(message =>
                                React.createElement('div', { key: message.id, className: 'message ' + message.type },
                                    React.createElement('div', { style: { whiteSpace: 'pre-line' } }, message.content)
                                )
                            ),
                            isGenerating && React.createElement('div', { className: 'loading' },
                                React.createElement('div', { className: 'spinner' }),
                                React.createElement('p', null, 'Generation en cours...')
                            )
                        ),
                        React.createElement('div', { className: 'input-area' },
                            React.createElement('div', { className: 'input-group' },
                                React.createElement('input', {
                                    type: 'text',
                                    value: inputMessage,
                                    onChange: (e) => setInputMessage(e.target.value),
                                    onKeyPress: (e) => e.key === 'Enter' && handleSendMessage(),
                                    placeholder: 'Decrivez votre projet',
                                    disabled: isGenerating
                                }),
                                React.createElement('button', {
                                    onClick: handleSendMessage,
                                    disabled: !inputMessage.trim() || isGenerating,
                                    className: 'btn btn-primary'
                                }, 'Envoyer')
                            )
                        )
                    ),
                    templates.length > 0 && React.createElement('div', null,
                        React.createElement('h2', null, 'Templates Generes (' + templates.length + ')'),
                        React.createElement('div', { className: 'templates-grid' },
                            templates.map(template =>
                                React.createElement('div', { key: template.id, className: 'template-card' },
                                    React.createElement('h3', null, template.name),
                                    React.createElement('p', { style: { fontSize: '14px', color: '#666', marginBottom: '10px' } },
                                        '"' + template.userInput + '"'
                                    ),
                                    React.createElement('p', { style: { fontSize: '12px', color: '#999' } },
                                        'Source: ' + template.source + ' | ' + template.htmlCode.length + ' caracteres'
                                    ),
                                    React.createElement('div', { className: 'template-actions' },
                                        React.createElement('button', {
                                            onClick: () => setPreviewModal(template),
                                            className: 'btn btn-primary',
                                            style: { fontSize: '14px' }
                                        }, 'Previsualiser'),
                                        React.createElement('button', {
                                            onClick: () => {
                                                const blob = new Blob([template.htmlCode], { type: 'text/html' });
                                                const url = URL.createObjectURL(blob);
                                                const a = document.createElement('a');
                                                a.href = url;
                                                a.download = 'template-' + template.id + '.html';
                                                a.click();
                                                URL.revokeObjectURL(url);
                                            },
                                            className: 'btn btn-success',
                                            style: { fontSize: '14px' }
                                        }, 'Telecharger')
                                    )
                                )
                            )
                        )
                    ),
                    previewModal && React.createElement(PreviewModal, {
                        template: previewModal,
                        onClose: () => setPreviewModal(null)
                    })
                )
            );
        };

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>