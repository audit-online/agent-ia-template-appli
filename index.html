<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent IA Template ‚Äì Dashboard Pro</title>

  <!-- React + Babel CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* ------- RESET + LAYOUT √âQUILIBR√â ------- */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f7fa;min-height:100vh;color:#333}
    .app-container{display:grid;grid-template-columns:1fr 400px;height:100vh;gap:1px;background:#e5e7eb}
    
    /* ZONE PRINCIPALE - CONVERSATION */
    .main-area{background:#fff;display:flex;flex-direction:column;overflow:hidden}
    .main-header{padding:20px 30px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-bottom:1px solid rgba(255,255,255,.2)}
    .main-header h1{font-size:1.4rem;font-weight:700;margin-bottom:5px}
    .main-header p{opacity:.9;font-size:.9rem}
    .status-badge{display:inline-flex;align-items:center;gap:8px;margin-top:10px;padding:6px 12px;background:rgba(255,255,255,.2);border-radius:15px;font-size:.8rem}
    .status-dot{width:6px;height:6px;border-radius:50%;background:#4ade80;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    
    /* CONVERSATION */
    .conversation{flex:1;overflow-y:auto;padding:25px;background:#fafbfc}
    .message{margin-bottom:20px;max-width:85%}
    .message.user{margin-left:auto}
    .message.user .bubble{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:20px 20px 5px 20px;padding:15px 20px;box-shadow:0 3px 15px rgba(102,126,234,.3)}
    .message.agent .bubble{background:#fff;border:1px solid #e5e7eb;border-radius:20px 20px 20px 5px;padding:15px 20px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .message-content{white-space:pre-line;line-height:1.6;font-size:14px}
    
    /* INPUT ZONE */
    .input-zone{padding:20px;background:#fff;border-top:1px solid #e5e7eb}
    .input-container{display:flex;gap:12px;align-items:end}
    .input-wrapper{flex:1;position:relative}
    .input-field{width:100%;min-height:50px;max-height:120px;padding:12px 16px;border:2px solid #e5e7eb;border-radius:15px;font-size:14px;font-family:inherit;resize:none;transition:all .2s;background:#f8fafc}
    .input-field:focus{outline:none;border-color:#667eea;background:#fff;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .send-btn{padding:12px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:15px;font-weight:600;cursor:pointer;transition:all .2s}
    .send-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 15px rgba(102,126,234,.4)}
    .send-btn:disabled{opacity:.6;cursor:not-allowed}
    
    /* SIDEBAR TEMPLATES */
    .sidebar{background:#fff;display:flex;flex-direction:column;overflow:hidden}
    .sidebar-header{padding:20px;background:#f8fafc;border-bottom:1px solid #e5e7eb}
    .sidebar-title{font-size:1.1rem;font-weight:700;color:#374151;margin-bottom:10px}
    .current-template{background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:15px;border-radius:12px;text-align:center;font-size:13px}
    .current-template .name{font-weight:600;margin-bottom:5px}
    .current-template .actions{display:flex;gap:8px;justify-content:center;margin-top:10px}
    .btn-sm{padding:6px 12px;border:none;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-outline{background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3)}
    .btn-outline:hover{background:rgba(255,255,255,.3)}
    
    /* LISTE TEMPLATES */
    .templates-list{flex:1;overflow-y:auto}
    .template-item{padding:15px 20px;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:all .2s}
    .template-item:hover{background:#f8fafc}
    .template-item.active{background:#f0f9ff;border-left:3px solid #3b82f6}
    .template-name{font-weight:600;color:#111827;font-size:13px;margin-bottom:5px}
    .template-meta{color:#6b7280;font-size:11px;margin-bottom:8px}
    .template-actions{display:flex;gap:6px}
    .btn-xs{padding:4px 8px;font-size:10px;border-radius:6px;border:none;cursor:pointer;transition:all .2s}
    .btn-primary{background:#3b82f6;color:#fff}
    .btn-secondary{background:#f3f4f6;color:#374151}
    .btn-xs:hover{transform:translateY(-1px)}
    
    /* LOADING */
    .thinking{display:flex;align-items:center;gap:10px;padding:15px 20px;background:#f0f9ff;border-radius:20px 20px 20px 5px;margin-bottom:20px;max-width:85%}
    .dots{display:flex;gap:4px}
    .dot{width:6px;height:6px;border-radius:50%;background:#3b82f6;animation:bounce 1.4s infinite ease-in-out}
    .dot:nth-child(1){animation-delay:-0.32s}
    .dot:nth-child(2){animation-delay:-0.16s}
    @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
    
    /* RESPONSIVE */
    @media(max-width:1024px){.app-container{grid-template-columns:1fr 300px}}
    @media(max-width:768px){.app-container{grid-template-columns:1fr;grid-template-rows:1fr auto}.sidebar{max-height:250px}}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [messages, setMessages] = useState([]);
      const [inputMessage, setInputMessage] = useState('');
      const [templates, setTemplates] = useState([]);
      const [isGenerating, setIsGenerating] = useState(false);
      const [currentTemplate, setCurrentTemplate] = useState(null);
      const [apiStatus, setApiStatus] = useState('testing');

      useEffect(() => {
        testAPI();
        
        // Test de la fonction d'ouverture d'onglet
        console.log('üß™ Test fonction ouverture onglet...');
        
        setMessages([{
          id: 1,
          type: 'agent',
          content: 'Bonjour ! Je suis Claude, votre expert en cr√©ation de sites web.\n\nAvec 15 ans d\'exp√©rience, je vous accompagne pour :\n‚Ä¢ Analyser les besoins de vos clients\n‚Ä¢ Recommander les meilleures solutions\n‚Ä¢ Cr√©er des templates sur-mesure\n‚Ä¢ Affiner vos projets\n\nParlez-moi de votre projet !'
        }]);
      }, []);

      const testAPI = async () => {
        try {
          const r = await fetch('/.netlify/functions/ai-chat', { method: 'GET' });
          const data = await r.json();
          setApiStatus('working');
          setMessages(prev => [...prev, { 
            id: Date.now(), 
            type: 'agent', 
            content: `‚úÖ API active - Cl√© configur√©e (${data.keyLength} caract√®res)` 
          }]);
        } catch {
          setApiStatus('broken');
          setMessages(prev => [...prev, { 
            id: Date.now(), 
            type: 'agent', 
            content: '‚ùå API indisponible - Mode test activ√©' 
          }]);
        }
      };

      const openTemplate = (template) => {
        try {
          console.log('üöÄ Ouverture template:', template.name);
          const blob = new Blob([template.htmlCode], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const newWindow = window.open(url, '_blank');
          
          if (newWindow) {
            console.log('‚úÖ Onglet ouvert avec succ√®s');
            setTimeout(() => URL.revokeObjectURL(url), 2000);
          } else {
            console.error('‚ùå Popup bloqu√©');
            // Fallback: t√©l√©charger si popup bloqu√©
            const a = document.createElement('a');
            a.href = url;
            a.download = `template-${template.id}.html`;
            a.click();
            URL.revokeObjectURL(url);
          }
        } catch (error) {
          console.error('‚ùå Erreur ouverture:', error);
        }
      };

      const downloadTemplate = (template) => {
        try {
          console.log('üíæ T√©l√©chargement template:', template.name);
          const blob = new Blob([template.htmlCode], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `template-${template.id}.html`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          console.log('‚úÖ T√©l√©chargement lanc√©');
        } catch (error) {
          console.error('‚ùå Erreur t√©l√©chargement:', error);
        }
      };

      const detectType = (input) => {
        const lower = input.toLowerCase();
        if (lower.includes('restaurant') || lower.includes('kebab')) return 'restaurant';
        if (lower.includes('boutique') || lower.includes('shop')) return 'ecommerce';
        if (lower.includes('portfolio')) return 'portfolio';
        return 'moderne';
      };

      const createTemplate = (userInput, htmlCode, source) => {
        const template = {
          id: Date.now(),
          name: `Template ${detectType(userInput)} ‚Äì ${new Date().toLocaleTimeString()}`,
          userInput,
          htmlCode,
          source,
          createdAt: new Date()
        };
        setTemplates(prev => [template, ...prev]);
        setCurrentTemplate(template);
        return template;
      };

      const handleSendMessage = async () => {
        if (!inputMessage.trim() || isGenerating) return;
        
        const userMessage = { id: Date.now(), type: 'user', content: inputMessage };
        const messageContent = inputMessage;
        setInputMessage('');
        setMessages(prev => [...prev, userMessage]);

        if (apiStatus !== 'working') {
          setMessages(prev => [...prev, { 
            id: Date.now(), 
            type: 'agent', 
            content: 'API non disponible. V√©rifiez la configuration.' 
          }]);
          return;
        }

        setIsGenerating(true);

        try {
          const fullConversation = [...messages, userMessage];
          const conversationHistory = fullConversation
            .filter(msg => msg.id !== 1)
            .map(msg => ({ role: msg.type === 'user' ? 'user' : 'assistant', content: msg.content }));

          // D√©tecter si c'est une demande de modification
          const isModificationRequest = currentTemplate && 
            (messageContent.toLowerCase().includes('modifi') ||
             messageContent.toLowerCase().includes('change') ||
             messageContent.toLowerCase().includes('ajuste') ||
             messageContent.toLowerCase().includes('am√©liore') ||
             messageContent.toLowerCase().includes('couleur') ||
             messageContent.toLowerCase().includes('taille'));

          let systemPrompt;
          
          if (isModificationRequest) {
            systemPrompt = `Tu es un expert en modification de templates HTML. 

CONTEXTE : L'utilisateur a un template existant et veut le modifier.

TEMPLATE ACTUEL :
${currentTemplate.htmlCode}

DEMANDE DE MODIFICATION : ${messageContent}

INSTRUCTIONS :
1. Analyse le template HTML existant
2. Applique EXACTEMENT la modification demand√©e
3. Conserve toute la structure et le design existant
4. Ne modifie que ce qui est explicitement demand√©
5. Retourne le HTML complet modifi√© (DOCTYPE ‚Üí </html>)
6. Assure-toi que le HTML reste valide et fonctionnel

IMPORTANT : R√©ponds UNIQUEMENT avec le code HTML complet modifi√©, sans explications.`;
          } else {
            systemPrompt = `Tu es Claude, expert senior en cr√©ation de sites web avec 15 ans d'exp√©rience.

R√àGLES :
- Donne des CONSEILS d'expert et des RECOMMANDATIONS
- Propose de cr√©er un template uniquement quand pertinent
- Cr√©e du code HTML complet SEULEMENT si demand√© explicitement avec : "cr√©er le template", "cr√©er un template", "g√©n√®re le code"
- Pour les conseils, termine par : "Voulez-vous que je cr√©e un template pour visualiser cette solution ?"

M√âMOIRE : Utilise tout l'historique de conversation pour donner des r√©ponses coh√©rentes.

HISTORIQUE : ${JSON.stringify(conversationHistory, null, 2)}`;
          }

          const res = await fetch('/.netlify/functions/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: messageContent,
              conversationHistory: conversationHistory,
              systemPrompt: systemPrompt
            })
          });

          const data = await res.json();
          
          // V√©rifier si c'est un template HTML complet
          const isRealTemplate = data.response.includes('<!DOCTYPE html>') && 
                                data.response.includes('<html') && 
                                data.response.includes('</html>') &&
                                data.response.length > 1000;
          
          if (isRealTemplate) {
            let html = data.response.replace(/```html\n?/g, '').replace(/```\n?/g, '').trim();
            
            if (isModificationRequest) {
              // Modification d'un template existant
              const modifiedTemplate = {
                ...currentTemplate,
                id: Date.now(),
                name: currentTemplate.name.replace('‚Äì', '(modifi√©) ‚Äì'),
                htmlCode: html,
                source: 'ai-modified'
              };
              setTemplates(prev => [modifiedTemplate, ...prev]);
              setCurrentTemplate(modifiedTemplate);
              
              setMessages(prev => [...prev, { 
                id: Date.now(), 
                type: 'agent', 
                content: '‚úÖ Template modifi√© avec succ√®s ! Les changements ont √©t√© appliqu√©s.' 
              }]);
              
              setTimeout(() => {
                console.log('‚è∞ Ouverture automatique template modifi√©...');
                openTemplate(modifiedTemplate);
              }, 1000);
            } else {
              // Nouveau template
              const template = createTemplate(messageContent, html, 'ai-expert');
              setMessages(prev => [...prev, { 
                id: Date.now(), 
                type: 'agent', 
                content: '‚úÖ Template cr√©√© ! Il va s\'ouvrir automatiquement.' 
              }]);
              
              setTimeout(() => {
                console.log('‚è∞ Ouverture automatique nouveau template...');
                openTemplate(template);
              }, 1000);
            }
          } else {
            // R√©ponse normale
            setMessages(prev => [...prev, { 
              id: Date.now(), 
              type: 'agent', 
              content: data.response 
            }]);
          }
          
        } catch (error) {
          setMessages(prev => [...prev, { 
            id: Date.now(), 
            type: 'agent', 
            content: 'Erreur technique. Pouvez-vous reformuler ?' 
          }]);
        } finally {
          setIsGenerating(false);
        }
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSendMessage();
        }
      };

      return (
        React.createElement('div', { className: 'app-container' },
          
          // ZONE PRINCIPALE - CONVERSATION
          React.createElement('div', { className: 'main-area' },
            React.createElement('div', { className: 'main-header' },
              React.createElement('h1', null, 'Agent IA Template'),
              React.createElement('p', null, 'Expert en cr√©ation de sites web'),
              React.createElement('div', { className: 'status-badge' },
                React.createElement('div', { className: 'status-dot' }),
                apiStatus === 'working' ? 'IA Claude Active' : 'Mode Test'
              )
            ),
            
            React.createElement('div', { className: 'conversation' },
              messages.map(msg => 
                React.createElement('div', { key: msg.id, className: `message ${msg.type}` },
                  React.createElement('div', { className: 'bubble' },
                    React.createElement('div', { className: 'message-content' }, msg.content)
                  )
                )
              ),
              
              isGenerating && React.createElement('div', { className: 'thinking' },
                React.createElement('div', { className: 'dots' },
                  React.createElement('div', { className: 'dot' }),
                  React.createElement('div', { className: 'dot' }),
                  React.createElement('div', { className: 'dot' })
                ),
                React.createElement('span', null, 'Claude r√©fl√©chit...')
              )
            ),
            
            React.createElement('div', { className: 'input-zone' },
              React.createElement('div', { className: 'input-container' },
                React.createElement('div', { className: 'input-wrapper' },
                  React.createElement('textarea', {
                    className: 'input-field',
                    value: inputMessage,
                    onChange: e => setInputMessage(e.target.value),
                    onKeyPress: handleKeyPress,
                    placeholder: currentTemplate ? 
                      'Demandez des modifications du template...' : 
                      'D√©crivez votre projet ou posez une question...',
                    disabled: isGenerating
                  })
                ),
                React.createElement('button', {
                  className: 'send-btn',
                  onClick: handleSendMessage,
                  disabled: !inputMessage.trim() || isGenerating
                }, '‚Üí')
              )
            )
          ),
          
          // SIDEBAR TEMPLATES
          React.createElement('div', { className: 'sidebar' },
            React.createElement('div', { className: 'sidebar-header' },
              React.createElement('div', { className: 'sidebar-title' }, 'Templates'),
              
              currentTemplate && React.createElement('div', { className: 'current-template' },
                React.createElement('div', { className: 'name' }, currentTemplate.name),
                React.createElement('div', null, 'Template actuel'),
                React.createElement('div', { className: 'actions' },
                  React.createElement('button', { 
                    className: 'btn-sm btn-outline', 
                    onClick: () => {
                      console.log('üñ±Ô∏è Clic bouton Voir - Template:', currentTemplate.name);
                      openTemplate(currentTemplate);
                    }
                  }, 'üöÄ Voir'),
                  React.createElement('button', { 
                    className: 'btn-sm btn-outline', 
                    onClick: () => downloadTemplate(currentTemplate)
                  }, 'üíæ DL')
                )
              ),
              
              // Bouton de test si pas de template
              !currentTemplate && React.createElement('button', {
                className: 'btn-sm',
                style: { background: '#f59e0b', color: '#fff', width: '100%', marginTop: '10px' },
                onClick: () => {
                  const testHTML = '<!DOCTYPE html><html><head><title>Test</title></head><body><h1>Test Template</h1><p>Si vous voyez ceci, l\'ouverture d\'onglet fonctionne !</p></body></html>';
                  const testTemplate = { id: 'test', name: 'Test', htmlCode: testHTML };
                  console.log('üß™ Test ouverture onglet...');
                  openTemplate(testTemplate);
                }
              }, 'üß™ Tester ouverture onglet')
            ),
            
            React.createElement('div', { className: 'templates-list' },
              templates.map(t => 
                React.createElement('div', { 
                  key: t.id, 
                  className: `template-item ${currentTemplate?.id === t.id ? 'active' : ''}`,
                  onClick: () => setCurrentTemplate(t)
                },
                  React.createElement('div', { className: 'template-name' }, t.name),
                  React.createElement('div', { className: 'template-meta' }, 
                    `${t.source} ‚Ä¢ ${t.createdAt.toLocaleTimeString()}`
                  ),
                  React.createElement('div', { className: 'template-actions' },
                    React.createElement('button', { 
                      className: 'btn-xs btn-primary', 
                      onClick: e => { e.stopPropagation(); openTemplate(t); }
                    }, 'Voir'),
                    React.createElement('button', { 
                      className: 'btn-xs btn-secondary', 
                      onClick: e => { e.stopPropagation(); downloadTemplate(t); }
                    }, 'DL')
                  )
                )
              ),
              
              templates.length === 0 && React.createElement('div', { 
                style: { padding: '20px', textAlign: 'center', color: '#6b7280', fontSize: '13px' }
              }, 'Aucun template cr√©√©')
            )
          )
        )
      );
    };

    ReactDOM.render(React.createElement(App), document.getElementById('root'));
  </script>
</body>
</html>