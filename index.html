<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent IA Template - Dashboard Pro</title>

    <!-- React & Babel UMDs (no build step) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
        .app-container{display:flex;height:100vh;overflow:hidden}
        .sidebar{width:400px;background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-right:1px solid rgba(255,255,255,.2);display:flex;flex-direction:column;box-shadow:2px 0 20px rgba(0,0,0,.1)}
        .sidebar-header{padding:25px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-bottom:1px solid rgba(255,255,255,.1)}
        .sidebar-header h1{font-size:1.5rem;font-weight:700;margin-bottom:8px}
        .sidebar-header p{opacity:.9;font-size:.9rem}
        .status-indicator{display:inline-flex;align-items:center;gap:8px;margin-top:15px;padding:8px 12px;background:rgba(255,255,255,.2);border-radius:20px;font-size:.8rem}
        .status-dot{width:8px;height:8px;border-radius:50%;background:#4ade80;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        .chat-section{flex:1;display:flex;flex-direction:column;min-height:0}
        .chat-messages{flex:1;overflow-y:auto;padding:20px;background:#f8fafc}
        .message{margin-bottom:15px;padding:15px;border-radius:12px;max-width:90%;word-wrap:break-word}
        .message.user{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;margin-left:auto;box-shadow:0 4px 12px rgba(102,126,234,.3)}
        .message.agent{background:#fff;border:1px solid #e5e7eb;box-shadow:0 2px 8px rgba(0,0,0,.05)}
        .input-area{padding:20px;background:#fff;border-top:1px solid #e5e7eb}
        .input-group{display:flex;gap:12px;align-items:end}
        .input-wrapper{flex:1;position:relative}
        .input-wrapper textarea{width:100%;min-height:44px;max-height:120px;padding:12px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:14px;font-family:inherit;resize:none;transition:all .2s}
        .input-wrapper textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
        .btn{padding:12px 24px;border:none;border-radius:12px;cursor:pointer;font-weight:600;font-size:14px;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
        .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;box-shadow:0 4px 12px rgba(102,126,234,.3)}
        .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.4)}
        .btn-primary:disabled{opacity:.6;cursor:not-allowed}
        .templates-section{border-top:1px solid #e5e7eb;background:#f8fafc;max-height:300px;overflow-y:auto}
        .templates-header{padding:15px 20px;background:#fff;border-bottom:1px solid #e5e7eb;font-weight:600;color:#374151}
        .template-item{padding:15px 20px;border-bottom:1px solid #e5e7eb;background:#fff;transition:all .2s;cursor:pointer}
        .template-item:hover{background:#f3f4f6}
        .template-name{font-weight:600;color:#111827;margin-bottom:4px}
        .template-meta{font-size:12px;color:#6b7280}
        .template-actions{display:flex;gap:8px;margin-top:10px}
        .btn-small{padding:6px 12px;font-size:12px;border-radius:8px}
        .btn-outline{background:transparent;border:1px solid #d1d5db;color:#374151}
        .btn-outline:hover{background:#f3f4f6;border-color:#9ca3af}
        .main-content{flex:1;display:flex;flex-direction:column;background:#fff;position:relative}
        .main-header{padding:20px 30px;background:#fff;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 3px rgba(0,0,0,.05)}
        .main-title{font-size:1.5rem;font-weight:700;color:#111827}
        .main-controls{display:flex;gap:12px;align-items:center}
        .view-toggle{display:flex;background:#f3f4f6;border-radius:10px;padding:4px}
        .view-toggle button{padding:8px 16px;border:none;background:transparent;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all .2s}
        .view-toggle button.active{background:#fff;color:#667eea;box-shadow:0 2px 4px rgba(0,0,0,.1)}
        .preview-area{flex:1;position:relative;overflow:hidden}
        .preview-iframe{width:100%;height:100%;border:none;background:#fff}
        .empty-state{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;color:#6b7280;text-align:center;padding:40px}
        .empty-state-icon{font-size:4rem;margin-bottom:20px;opacity:.5}
        .empty-state h3{font-size:1.5rem;margin-bottom:10px;color:#374151}
        .empty-state p{font-size:1rem;line-height:1.6}
        .code-editor{width:100%;height:100%;border:none;background:#1e1e1e;color:#d4d4d4;font-family:'Monaco','Menlo','Ubuntu Mono',monospace;font-size:14px;padding:20px;resize:none;outline:none}
        .loading-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10}
        .spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .device-frame{padding:20px;background:#f8fafc;height:100%;display:flex;justify-content:center;align-items:flex-start;overflow:auto}
        .device{background:#333;border-radius:25px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,.3)}
        .device.desktop{width:90%;max-width:1200px;aspect-ratio:16/10}
        .device.tablet{width:400px;aspect-ratio:4/3}
        .device.mobile{width:280px;aspect-ratio:9/16}
        .device iframe{width:100%;height:100%;border:none;border-radius:15px;background:#fff}
        @media(max-width:1024px){.sidebar{width:350px}}
        @media(max-width:768px){.app-container{flex-direction:column}.sidebar{width:100%;height:50vh}}
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [templates, setTemplates] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            const [currentTemplate, setCurrentTemplate] = useState(null);
            const [viewMode, setViewMode] = useState('preview');
            const [deviceView, setDeviceView] = useState('desktop');
            const [apiStatus, setApiStatus] = useState('testing');

            useEffect(() => {
                testAPI();
                setMessages([{
                    id: 1,
                    type: 'agent',
                    content: 'Agent IA Template - Dashboard Pro\n\nDiagnostic en cours...\n\nJe teste l API puis je vous donnerai des templates de qualite professionnelle.\n\nInterface: Dashboard complet avec previsualisation plein ecran'
                }]);
            }, []);

            const testAPI = async () => {
                try {
                    const response = await fetch('/.netlify/functions/ai-chat', { method: 'GET' });
                    if (response.ok) {
                        setApiStatus('working');
                        setMessages(prev => [...prev, {
                            id: Date.now(),
                            type: 'agent',
                            content: 'API Netlify fonctionnelle !\n\nPret a generer des templates professionnels avec Claude.\n\nDecrivez votre projet dans le chat pour commencer.'
                        }]);
                    } else {
                        throw new Error('API inaccessible: ' + response.status);
                    }
                } catch (error) {
                    setApiStatus('broken');
                    setMessages(prev => [...prev, {
                        id: Date.now(),
                        type: 'agent',
                        content: 'API Netlify inaccessible\n\nSolutions:\n- Verifiez le deploiement Netlify\n- Verifiez la cle API Claude\n- Testez la fonction directement\n\nMode degrade: Templates de test disponibles'
                    }]);
                }
            };

            const handleSendMessage = async () => {
                if (!inputMessage.trim()) return;
                const userMessage = { id: Date.now(), type: 'user', content: inputMessage };
                setMessages(prev => [...prev, userMessage]);
                setInputMessage('');
                if (apiStatus === 'working') {
                    await generateWithAI(inputMessage);
                } else {
                    generateTestTemplate(inputMessage);
                }
            };

            const generateWithAI = async (userInput) => {
                setIsGenerating(true);
                try {
                    const res = await fetch('/.netlify/functions/ai-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: 'Genere un template HTML complet et professionnel pour: ' + userInput,
                            systemPrompt: 'Cree un template HTML complet, moderne et professionnel. IMPORTANT: Reponds UNIQUEMENT avec du code HTML complet. Le HTML doit inclure: DOCTYPE html, Head avec meta tags, CSS integre moderne et responsive, Body avec contenu complet et professionnel, JavaScript pour les interactions. Utilise un design moderne avec animations CSS, couleurs harmonieuses, typographie soignee et UX optimisee. Le template doit etre pret pour la production.'
                        })
                    });
                    if (!res.ok) throw new Error('Erreur ' + res.status);
                    const result = await res.json();
                    let htmlCode = result.response
                        .replace(/```html\n?/g, '')
                        .replace(/```\n?/g, '')
                        .trim();
                    if (!htmlCode.includes('<!DOCTYPE')) {
                        htmlCode = '<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Template Genere</title></head><body>' + htmlCode + '</body></html>';
                    }
                    const template = createTemplate(userInput, htmlCode, 'ai');
                    setCurrentTemplate(template);
                    setMessages(prev => [...prev, {
                        id: Date.now(),
                        type: 'agent',
                        content: `Template professionnel g√©n√©r√© par Claude ! ${template.name}\n\nVisible dans la pr√©visualisation plein √©cran.\nTestez sur diff√©rents appareils avec les boutons de vue.`
                    }]);
                } catch (error) {
                    console.error('Erreur IA:', error);
                    generateTestTemplate(userInput);
                    setMessages(prev => [...prev, {
                        id: Date.now(),
                        type: 'agent',
                        content: `Erreur IA - Template de test cr√©√©\n\nErreur: ${error.message}\n\nTemplate de fallback g√©n√©r√© pour tester l'interface.`
                    }]);
                } finally {
                    setIsGenerating(false);
                }
            };

            const generateTestTemplate = (userInput) => {
                const testHTML = createTestHTML(userInput);
                const template = createTemplate(userInput, testHTML, 'test');
                setCurrentTemplate(template);
                setMessages(prev => [...prev, {
                    id: Date.now(),
                    type: 'agent',
                    content: 'Template de test cr√©√©\n\nPr√©visualisation fonctionnelle.\nCorrigez l‚ÄôAPI pour des templates IA professionnels.'
                }]);
            };

            const createTestHTML = (userInput) => {
                const type = detectType(userInput);
                return `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Template ${type}</title>
  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;color:#fff;display:flex;align-items:center;justify-content:center}
    .container{max-width:1200px;margin:auto;text-align:center;padding:40px 20px}
    h1{font-size:3rem;margin-bottom:10px}
    .content{background:rgba(255,255,255,.95);color:#333;padding:60px;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);margin-top:40px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:30px;margin-top:40px}
    .card{background:#fff;padding:40px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);transition:transform .3s}
    .card:hover{transform:translateY(-10px)}
    .card h3{color:#667eea;margin-bottom:15px;font-size:1.5rem}
  </style>
</head>
<body>
  <div class="container">
    <h1>Template ${type.toUpperCase()}</h1>
    <p style="font-size:1.2rem">Demande: ${userInput}</p>
    <div class="content">
      <h2>Template Professionnel</h2>
      <div class="grid">
        <div class="card"><h3>Design Premium</h3><p>Interface moderne avec animations fluides et design responsive.</p></div>
        <div class="card"><h3>Performance</h3><p>Code optimis√© et JavaScript performant pour une UX exceptionnelle.</p></div>
        <div class="card"><h3>Multi-device</h3><p>Conception responsive pour mobiles, tablettes et ordinateurs.</p></div>
      </div>
    </div>
  </div>
</body>
</html>`;
            };

            const detectType = (input) => {
                const lower = input.toLowerCase();
                if (lower.includes('restaurant') || lower.includes('cafe') || lower.includes('food')) return 'restaurant';
                if (lower.includes('boutique') || lower.includes('ecommerce') || lower.includes('shop')) return 'ecommerce';
                if (lower.includes('portfolio') || lower.includes('artiste') || lower.includes('photo')) return 'portfolio';
                if (lower.includes('agence') || lower.includes('cabinet') || lower.includes('avocat')) return 'business';
                return 'moderne';
            };

            const createTemplate = (userInput, htmlCode, source) => {
                const template = {
                    id: Date.now(),
                    name: `Template ${detectType(userInput)} - ${new Date().toLocaleTimeString()}`,
                    userInput,
                    htmlCode,
                    source,
                    createdAt: new Date()
                };
                setTemplates(prev => [template, ...prev]);
                return template;
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };

            const downloadTemplate = (template) => {
                const blob = new Blob([template.htmlCode], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `template-${template.id}.html`;
                a.click();
                URL.revokeObjectURL(url);
            };

            return (
                React.createElement('div', { className: 'app-container' },
                    React.createElement('div', { className: 'sidebar' },
                        React.createElement('div', { className: 'sidebar-header' },
                            React.createElement('h1', null, 'Agent IA Template'),
                            React.createElement('p', null, 'Dashboard Professionnel'),
                            React.createElement('div', { className: 'status-indicator' },
                                React.createElement('div', { className: 'status-dot' }),
                                apiStatus === 'working' ? 'IA Claude Active' : 'Mode Test'
                            )
                        ),
                        React.createElement('div', { className: 'chat-section' },
                            React.createElement('div', { className: 'chat-messages' },
                                messages.map(msg => React.createElement('div', { key: msg.id, className: `message ${msg.type}` },
                                    React.createElement('div', { style: { whiteSpace: 'pre-line' } }, msg.content)
                                )),
                                isGenerating && React.createElement('div', { className: 'message agent' },
                                    React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                        React.createElement('div', { className: 'spinner', style: { width: 20, height: 20 } }),
                                        'G√©n√©ration en cours...'
                                    )
                                )
                            ),
                            React.createElement('div', { className: 'input-area' },
                                React.createElement('div', { className: 'input-group' },
                                    React.createElement('div', { className: 'input-wrapper' },
                                        React.createElement('textarea', {
                                            value: inputMessage,
                                            onChange: e => setInputMessage(e.target.value),
                                            onKeyPress: handleKeyPress,
                                            placeholder: 'D√©crivez votre projet...',
                                            disabled: isGenerating
                                        })
                                    ),
                                    React.createElement('button', {
                                        onClick: handleSendMessage,
                                        disabled: !inputMessage.trim() || isGenerating,
                                        className: 'btn btn-primary'
                                    }, 'G√©n√©rer')
                                )
                            )
                        ),
                        templates.length > 0 && React.createElement('div', { className: 'templates-section' },
                            React.createElement('div', { className: 'templates-header' }, `Templates (${templates.length})`),
                            templates.slice(0, 5).map(t => React.createElement('div', {
                                key: t.id,
                                className: 'template-item',
                                onClick: () => setCurrentTemplate(t)
                            },
                                React.createElement('div', { className: 'template-name' }, t.name),
                                React.createElement('div', { className: 'template-meta' }, `${t.userInput.substring(0, 50)}... | ${t.source}`),
                                React.createElement('div', { className: 'template-actions' },
                                    React.createElement('button', { className: 'btn btn-small btn-outline', onClick: e => { e.stopPropagation(); setCurrentTemplate(t); } }, 'Voir'),
                                    React.createElement('button', { className: 'btn btn-small btn-outline', onClick: e => { e.stopPropagation(); downloadTemplate(t); } }, 'DL')
                                )
                            ))
                        )
                    ),
                    React.createElement('div', { className: 'main-content' },
                        React.createElement('div', { className: 'main-header' },
                            React.createElement('h1', { className: 'main-title' }, currentTemplate ? currentTemplate.name : 'Pr√©visualisation'),
                            React.createElement('div', { className: 'main-controls' },
                                React.createElement('div', { className: 'view-toggle' },
                                    React.createElement('button', { className: viewMode === 'preview' ? 'active' : '', onClick: () => setViewMode('preview') }, 'Aper√ßu'),
                                    React.createElement('button', { className: viewMode === 'code' ? 'active' : '', onClick: () => setViewMode('code') }, 'Code')
                                ),
                                viewMode === 'preview' && React.createElement('div', { className: 'view-toggle' },
                                    React.createElement('button', { className: deviceView === 'desktop' ? 'active' : '', onClick: () => setDeviceView('desktop') }, 'Desktop'),
                                    React.createElement('button', { className: deviceView === 'tablet' ? 'active' : '', onClick: () => setDeviceView('tablet') }, 'Tablet'),
                                    React.createElement('button', { className: deviceView === 'mobile' ? 'active' : '', onClick: () => setDeviceView('mobile') }, 'Mobile')
                                )
                            )
                        ),
                        React.createElement('div', { className: 'preview-area' },
                            !currentTemplate && React.createElement('div', { className: 'empty-state' },
                                React.createElement('div', { className: 'empty-state-icon' }, 'üé®'),
                                React.createElement('h3', null, 'Aucun template s√©lectionn√©'),
                                React.createElement('p', null, 'G√©n√©rez un template avec l‚ÄôIA ou s√©lectionnez-en un existant pour le voir ici en plein √©cran.')
                            ),
                            currentTemplate && viewMode === 'code' && React.createElement('textarea', {
                                className: 'code-editor',
                                value: currentTemplate.htmlCode,
                                readOnly: true,
                                spellCheck: false
                            }),
                            currentTemplate && viewMode === 'preview' && React.createElement('div', { className: 'device-frame' },
                                React.createElement('div', { className: `device ${deviceView}` },
                                    React.createElement('iframe', {
                                        srcDoc: currentTemplate.htmlCode,
                                        title: 'Preview'
                                    })
                                )
                            ),
                            isGenerating && React.createElement('div', { className: 'loading-overlay' },
                                React.createElement('div', { className: 'spinner' }),
                                React.createElement('p', null, 'G√©n√©ration du template en cours...'),
                                React.createElement('p', { style: { fontSize: 14, opacity: .7, marginTop: 8 } }, 'IA Claude en action')
                            )
                        )
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>